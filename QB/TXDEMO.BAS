DEFINT A-Z
DECLARE FUNCTION n$ (n%)
DECLARE SUB TX (s AS STRING)

TYPE FontDataT
    CH0 AS STRING * 1
    CH1 AS STRING * 1
    FONT AS INTEGER
    W AS INTEGER
    H AS INTEGER
    TOP AS INTEGER
    BOTTOM AS INTEGER
    ATTR AS INTEGER
    BUFLEN AS INTEGER
END TYPE
DIM SHARED ASM(100) AS INTEGER,BITMAP(8194) AS INTEGER

DEF SEG=VARSEG(ASM(0))
BLOAD "UTIL.BIN",VARPTR(ASM(0))
ST=0:CALL ABSOLUTE(ST,VARPTR(ASM(0))+ASM(0))
IF ST=0 THEN PRINT "Please run UCDOS and TX first.":END
IF ST=1 THEN PRINT "Please run TX first.":END
DEF SEG

OPEN "LPT3" FOR OUTPUT AS #1
TX ("M10CU1,0CO8KB1,0CL0")

I = 0:H=20
FOR y = 0 TO 15
  FOR x = 0 TO 15
    TX("CO"+n$(I)+"B"+n$(x*40)+","+n$(y*H)+","+n$(x*40+40)+","+n$((y+1)*H))
    I=I+1
  NEXT x
NEXT y
TX ("CO7")
FOR FONT=0 TO 3
  TX ("{(7@52,52=" + n$(FONT) + "-" + n$(FONT*160) + "|"+n$(H*16)+"}")
  TX ("{×ÖÌå" + n$(FONT) + "}")
NEXT FONT
FOR FONT=0 TO 10
  CALL DrawStr("Font"+STR$(FONT),(FONT AND 3)*160,(FONT\4)*32+H*16+52,FONT,16,32,7)
NEXT FONT
WHILE INPUT$(1) = "": WEND

TX ("KB1,1M3CU1,1")
CLOSE
END

FUNCTION n$ (A AS INTEGER)
n$ = LTRIM$(RTRIM$(STR$(A)))
END FUNCTION

SUB TX (s AS STRING)
PRINT #1, CHR$(14); "["; s; "]";
END SUB

SUB DrawStr(STR AS STRING, X1 AS INTEGER, Y1 AS INTEGER, FONT AS INTEGER, W0 AS INTEGER, H AS INTEGER, C AS INTEGER)
  I=0: L=LEN(STR): WA=W0: XA=X1
  WHILE I<L
    CH$=MID$(STR,I+1,1)
    IF ASC(CH$)>=&H80 THEN
      I=I+1: CH$=CH$+MID$(STR,I+1,1)
    END IF
    WA=W0: CALL GetChar(CH$,FONT,WA,H,1)
    CALL DrawChar(WA,H,XA,Y1,C,BITMAP())
    XA=XA+WA: I=I+1
  WEND
END SUB

SUB GetChar(STR AS STRING,FONT AS INTEGER,W AS INTEGER,H AS INTEGER,ATTR AS INTEGER)
  STATIC Param AS FontDataT
  IF ASC(MID$(STR,1,1)) < &H80 THEN
    Param.CH0=STR: Param.CH1=CHR$(0)
    Param.W=W
  ELSE
    Param.CH0=MID$(STR,2,1): Param.CH1=MID$(STR,1,1)
    Param.W=W*2
  END IF
  Param.FONT=FONT: Param.H=H
  Param.TOP=0: Param.BOTTOM=H-1
  Param.ATTR=1: Param.BUFLEN=16384
  DS=VARSEG(Param):ES=VARSEG(BITMAP(0))
  SI=VARPTR(Param):DI=VARPTR(BITMAP(0))
  DEF SEG=VARSEG(ASM(0))
  CALL ABSOLUTE(BYVAL ES,BYVAL DI,BYVAL DS,BYVAL SI,VARPTR(ASM(0))+ASM(1))
  DEF SEG
  W=Param.W
END SUB

SUB DrawChar(W AS INTEGER, H AS INTEGER, X AS INTEGER, Y AS INTEGER, C AS INTEGER, B() AS INTEGER)
  STATIC DS,SI
  DS=VARSEG(B(0)):SI=VARPTR(B(0))
  DEF SEG=VARSEG(ASM(0))
  CALL ABSOLUTE(BYVAL DS,BYVAL SI,BYVAL H,BYVAL W,BYVAL Y,BYVAL X,BYVAL C,VARPTR(ASM(0))+ASM(2))
  DEF SEG
END SUB

