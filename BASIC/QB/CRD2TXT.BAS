DEFINT A-Z

TYPE CrdMetaT
  MAGIC AS STRING*3
  COUNT AS INTEGER
END TYPE
TYPE CrdHeaderT
  RES AS STRING*6
  OFFSET AS LONG
  FLAG AS STRING*1
  TEXT AS STRING*41
END TYPE
TYPE CrdContentT
  FLAG AS INTEGER
  SIZE AS INTEGER
  TEXT AS STRING*400
END TYPE

DIM CRDMETA AS CrdMetaT,CRDHDR AS CrdHeaderT,CRDCONTENT AS CrdContentT

PRINT "*** Windows Cardfile Format Converter ***":PRINT ""
INPUT "Source .CRD file:",F$
OPEN F$ FOR BINARY ACCESS READ AS #1
GET #1,1,CRDMETA
IF CRDMETA.MAGIC<>"MGC" THEN CLOSE #1:PRINT "Unsupported file format.":END
INPUT "Destination file:",F$
OPEN F$ FOR OUTPUT AS #2

FOR I=0 TO CRDMETA.COUNT-1
  GET #1,6+I*52,CRDHDR
  PRINT#2,".TITLE:";MID$(CRDHDR.TEXT,1,INSTR(CRDHDR.TEXT,CHR$(0))-1)
  GET #1,CRDHDR.OFFSET+1,CRDCONTENT
  TEXT$=MID$(CRDCONTENT.TEXT,1,CRDCONTENT.SIZE)
  PRINT#2,".TEXT:";LTRIM$(RTRIM$(STR$(COUNTLINES(TEXT$))))
  PRINT#2,TEXT$
  PRINT#2,""
NEXT I

PRINT "Conversion finished."
CLOSE #2
CLOSE #1

END

FUNCTION COUNTLINES(S AS STRING)
  STATIC C,P
  C=1:P=INSTR(1,S,CHR$(&H0A))
  WHILE P>0
    C=C+1
    P=INSTR(P+1,S,CHR$(&H0A))
  WEND
  COUNTLINES=C
END FUNCTION

