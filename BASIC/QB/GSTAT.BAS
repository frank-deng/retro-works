DEFINT A-Z

DIM SHARED B(15) AS INTEGER,N(5039) AS INTEGER,T(9999)AS INTEGER
DIM SHARED RES(1,15) AS LONG
COMMON SHARED NOCSV,RMAX
RANDOMIZE TIMER
FOR I=0 TO 10:B(I)=2^I:NEXT I
F$="GSTAT.CSV"
NOCSV=0:RMAX=7

PRINT "Initializing...";
P=0:FOR I=0 TO 9999
  IF UNIQDIGIT(I) THEN N(P)=I:P=P+1
NEXT I
CALL LOADDATA(F$)
CLS
LOCATE 25,1:PRINT "Press Esc to exit";

CALL PRINTSTAT
TS#=TIMER:TP#=TIMER
WHILE G>=0
  TM#=TIMER
  IF TM#<TP# OR TM#-TP#>1 THEN TP#=TM#:CALL PRINTSTAT
  IF TM#<TS# OR TM#-TS#>120 THEN TS#=TM#:CALL SAVEDATA(F$)
  G=GUESS
  IF G>0 THEN
    G=G-1
    RES(0,G)=RES(0,G)+1
    IF G>RMAX THEN RMAX=G
    G=GUESSM
    IF G>0 THEN
      G=G-1
      RES(1,G)=RES(1,G)+1
      IF G>RMAX THEN RMAX=G
    END IF
  END IF
WEND
CLS:CALL SAVEDATA(F$):END

ErrorHandler:
NOCSV=1
RESUME NEXT

SUB PRINTSTAT
  LOCATE 1,1:PRINT "Guesses     Normal Mastermind"
  SUM0=0:SUM1=0
  FOR I=0 TO RMAX
    PRINT LTRIM$(STR$(I+1));TAB(9);
    PRINT USING "########## ##########";RES(0,I);RES(1,I)
    SUM0=SUM0+RES(0,I):SUM1=SUM1+RES(1,I)
  NEXT I
  PRINT "Total";TAB(9);
  PRINT USING "########## ##########";SUM0;SUM1
END SUB

SUB LOADDATA(FILENAME AS STRING)
  DIM IDX AS INTEGER,P AS INTEGER
  ON ERROR GOTO ErrorHandler
  OPEN FILENAME FOR INPUT AS #1
  ON ERROR GOTO 0
  IF NOCSV<>0 THEN EXIT SUB
  LINE INPUT #1,S$
  WHILE NOT EOF(1)
    LINE INPUT #1,S$
    S$=LTRIM$(RTRIM$(S$))
    IF S$<>"" THEN
      P=INSTR(S$,","):V$=LEFT$(S$,P-1):S$=MID$(S$,P+1)
      G=VAL(V$)-1
      IF G>RMAX THEN RMAX=G
      P=INSTR(S$,","):V$=LEFT$(S$,P-1):S$=MID$(S$,P+1)
      RES(0,G)=VAL(V$):RES(1,G)=VAL(S$)
    END IF
  WEND
  CLOSE #1
END SUB

SUB SAVEDATA(FILENAME AS STRING)
  DIM ROWS AS INTEGER
  ROWS=7
  FOR I=8 TO 15
    IF RES(0,I)>0 OR RES(1,I)>0 THEN ROWS=I
  NEXT I
  OPEN FILENAME FOR OUTPUT AS #1
  PRINT #1,"Guesses,Normal,Mastermind"
  FOR I=0 TO ROWS
    PRINT #1,LTRIM$(RTRIM$(STR$(I+1)));
    PRINT #1,",";LTRIM$(RTRIM$(STR$(RES(0,I))));
    PRINT #1,",";LTRIM$(RTRIM$(STR$(RES(1,I))))
  NEXT I
  CLOSE #1
END SUB

FUNCTION UNIQDIGIT(N AS INTEGER)
  DIM MAP AS INTEGER,D AS INTEGER
  UNIQDIGIT=0
  MAP=B(D MOD 10)
  D=(N\10) MOD 10
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION ELSE MAP=MAP OR B(D)
  D=(N\100) MOD 10
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION ELSE MAP=MAP OR B(D)
  D=(N\1000)
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION
  UNIQDIGIT=1
END FUNCTION

FUNCTION COMP(A AS INTEGER,B AS INTEGER)
  DIM DA AS INTEGER,DB AS INTEGER
  DIM MA AS INTEGER,MB AS INTEGER,RS AS INTEGER
  IF A=B THEN COMP=&H40:EXIT FUNCTION
  DA=A MOD 10:DB=B MOD 10
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=(A\10) MOD 10:DB=(B\10) MOD 10
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=(A\100) MOD 10:DB=(B\100) MOD 10
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=A\1000:DB=B\1000
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  MA=MA AND MB:WHILE MA<>0:MA=MA AND (MA-1):RS=RS+1:WEND
  COMP=RS
END FUNCTION

FUNCTION COMPM(A AS INTEGER,B AS INTEGER)
  DIM DA AS INTEGER,DB AS INTEGER
  DIM M(9,1) AS INTEGER,I AS INTEGER,RS AS INTEGER
  IF A=B THEN COMPM=&H40:EXIT FUNCTION
  DA=A MOD 10:DB=B MOD 10
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=(A\10) MOD 10:DB=(B\10) MOD 10
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=(A\100) MOD 10:DB=(B\100) MOD 10
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=A\1000:DB=B\1000
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  FOR I=0 TO 9:DA0=M(I,0):DA1=M(I,1)
    IF DA0<DA1 THEN RS=RS+DA0 ELSE RS=RS+DA1
  NEXT I
  COMPM=RS
END FUNCTION

FUNCTION GUESS()
  DIM ANS AS INTEGER,G AS INTEGER,TL AS INTEGER,TP AS INTEGER,TIMES AS INTEGER
  DIM RS AS INTEGER,RS2 AS INTEGER
  DIM I AS INTEGER,NI AS INTEGER,NG AS INTEGER
  ANS=INT(RND*5039):G=INT(RND*5039)
  IF ANS=G THEN GUESS=1:EXIT FUNCTION
  ANS=N(ANS):NG=N(G)
  RS=COMP(ANS,NG):TL=0:TIMES=1
  FOR I=0 TO 5039
    IF INKEY$=CHR$(27) THEN GUESS=-1:EXIT FUNCTION
    IF I<>G THEN
      NI=N(I):RS2=COMP(NI,NG)
      IF RS=RS2 THEN T(TL)=NI:TL=TL+1
    END IF
  NEXT I
  WHILE TL>1
    G=INT(RND*(TL-1)):NG=T(G):RS=COMP(ANS,NG)
    IF RS=&H40 THEN GUESS=TIMES+1:EXIT FUNCTION
    TP=0:FOR I=0 TO TL-1
      IF INKEY$=CHR$(27) THEN GUESS=-1:EXIT FUNCTION
      IF I<>G THEN
        NI=T(I):RS2=COMP(NI,NG)
        IF RS=RS2 THEN T(TP)=NI:TP=TP+1
      END IF
    NEXT I
    TL=TP:TIMES=TIMES+1
  WEND
  IF T(0)<>ANS OR TL<1 THEN CLS:PRINT "Error";T(0);ANS;TL:END
  GUESS=TIMES
END FUNCTION

FUNCTION GUESSM()
  DIM ANS AS INTEGER,G AS INTEGER,TL AS INTEGER,TP AS INTEGER,TIMES AS INTEGER
  DIM I AS INTEGER
  ANS=INT(RND*9999):G=INT(RND*9999)
  IF ANS=G THEN GUESSM=1:EXIT FUNCTION
  RS=COMPM(ANS,G):TL=0:TIMES=1
  FOR I=0 TO 9999
    IF INKEY$=CHR$(27) THEN GUESSM=-1:EXIT FUNCTION
    IF I<>G THEN
      RS2=COMPM(I,G)
      IF RS=RS2 THEN T(TL)=I:TL=TL+1
    END IF
  NEXT I
  WHILE TL>1
    G=INT(RND*(TL-1)):NG=T(G):RS=COMPM(ANS,NG)
    IF RS=&H40 THEN GUESSM=TIMES+1:EXIT FUNCTION
    TP=0:FOR I=0 TO TL-1
      IF INKEY$=CHR$(27) THEN GUESSM=-1:EXIT FUNCTION
      IF I<>G THEN
        NI=T(I):RS2=COMPM(NI,NG)
        IF RS=RS2 THEN T(TP)=NI:TP=TP+1
      END IF
    NEXT I
    TL=TP:TIMES=TIMES+1
  WEND
  IF T(0)<>ANS OR TL<1 THEN CLS:PRINT "Error2";T(0);ANS;TL:END
  GUESSM=TIMES
END FUNCTION

