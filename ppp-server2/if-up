#!/bin/sh
# /etc/ppp/if-up

# 获取当前连接信息
CURRENT_USER="$PEERNAME"
CURRENT_PID="$PPPD_PID"
CURRENT_IFACE="$DEVICE"

# 只处理有用户名的情况
if [ -z "$CURRENT_USER" ]; then
    exit 0
fi

# 查找同一用户的其他PPP进程
ps -ef | grep -E '[p]ppd .* (user|name) '"$CURRENT_USER"'\>' | grep -v "$CURRENT_PID" | while read -r line; do
    OLD_PID=$(echo "$line" | awk '{print $2}')
    OLD_IFACE=$(echo "$line" | grep -o 'ifname \S*' | awk '{print $2}')
    
    # 安全验证：确保不是当前进程
    if [ "$OLD_PID" -ne "$CURRENT_PID" ] && [ -n "$OLD_PID" ]; then
        logger "PPP KICK: Terminating old connection $OLD_IFACE (PID:$OLD_PID) for user $CURRENT_USER"
        kill -TERM "$OLD_PID" 2>/dev/null
    fi
done
exit 0
